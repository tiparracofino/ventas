<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Â£≤„ÇäÂ†¥ ¬∑ Uriba</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@300;400;700&family=Noto+Sans+JP:wght@300;400&family=Cinzel:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root {
    --ink: #1a1a1a;
    --paper: #f8f5f0;
    --red: #c0392b;
    --red-light: #e74c3c;
    --gray: #888;
    --border: #d4cfc9;
    --shadow: rgba(0,0,0,0.08);
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: 'Noto Sans JP', sans-serif;
    background: var(--paper);
    color: var(--ink);
    min-height: 100vh;
    font-weight: 300;
    -webkit-tap-highlight-color: transparent;
  }
  
  /* Ajuste para el notch del iPhone */
  header {
    background: var(--ink);
    color: var(--paper);
    padding: calc(20px + env(safe-area-inset-top)) 24px 16px;
    position: sticky;
    top: 0;
    z-index: 100;
    border-bottom: 3px solid var(--red);
  }
  .header-inner {
    max-width: 640px;
    margin: 0 auto;
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: relative; /* A√±adido para posicionar los botones centrales */
  }
  .logo {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }
  .logo-jp {
    font-family: 'Noto Serif JP', serif;
    font-size: 22px;
    font-weight: 700;
    letter-spacing: 4px;
    color: var(--paper);
  }
  .logo-sub {
    font-size: 9px;
    letter-spacing: 3px;
    color: var(--gray);
    text-transform: uppercase;
  }
  .logo-dot {
    width: 6px; height: 6px;
    background: var(--red);
    border-radius: 50%;
    display: inline-block;
    margin-left: 4px;
    vertical-align: middle;
  }

  /* Botones de Exportar/Importar en el centro */
  .header-center {
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 6px;
  }
  .io-btn {
    background: none;
    border: 1px solid rgba(255,255,255,0.15);
    color: rgba(255,255,255,0.6);
    font-size: 8px;
    padding: 4px 8px;
    text-transform: uppercase;
    letter-spacing: 1px;
    cursor: pointer;
    border-radius: 2px;
    transition: all 0.2s;
    font-family: 'Noto Sans JP', sans-serif;
  }
  .io-btn:active {
    color: var(--paper);
    border-color: var(--paper);
  }

  /* Nav */
  nav {
    max-width: 640px;
    margin: 0 auto;
    display: flex;
    border-bottom: 1px solid var(--border);
    background: var(--paper);
    position: sticky;
    top: calc(79px + env(safe-area-inset-top));
    z-index: 99;
  }
  nav button {
    flex: 1;
    padding: 14px 8px;
    background: none;
    border: none;
    font-family: 'Noto Sans JP', sans-serif;
    font-size: 11px;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    color: var(--gray);
    cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: all 0.2s;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
  }
  nav button .nav-jp {
    font-family: 'Noto Serif JP', serif;
    font-size: 14px;
    color: var(--ink);
  }
  nav button.active {
    color: var(--red);
    border-bottom-color: var(--red);
  }
  nav button.active .nav-jp { color: var(--red); }

  /* Main */
  main {
    max-width: 640px;
    margin: 0 auto;
    padding: 24px 16px 100px;
  }

  /* Buttons */
  .btn-primary {
    background: var(--ink);
    color: var(--paper);
    border: none;
    padding: 12px 24px;
    font-family: 'Noto Sans JP', sans-serif;
    font-size: 12px;
    letter-spacing: 2px;
    text-transform: uppercase;
    cursor: pointer;
    transition: background 0.2s;
  }
  .btn-primary:active { background: var(--red); }
  .btn-red {
    background: var(--red);
    color: white;
    border: none;
    padding: 8px 16px;
    font-family: 'Noto Sans JP', sans-serif;
    font-size: 11px;
    letter-spacing: 1px;
    cursor: pointer;
    transition: opacity 0.2s;
  }
  .btn-red:active { opacity: 0.85; }
  .btn-ghost {
    background: none;
    border: 1px solid var(--border);
    padding: 8px 16px;
    font-family: 'Noto Sans JP', sans-serif;
    font-size: 11px;
    letter-spacing: 1px;
    cursor: pointer;
    color: var(--ink);
    transition: border-color 0.2s;
  }
  .btn-ghost:active { border-color: var(--ink); }

  /* Section header */
  .section-head {
    display: flex;
    align-items: baseline;
    gap: 12px;
    margin-bottom: 24px;
    padding-bottom: 12px;
    border-bottom: 1px solid var(--border);
  }
  .section-head h2 {
    font-family: 'Noto Serif JP', serif;
    font-size: 20px;
    font-weight: 400;
  }
  .section-head span {
    font-size: 11px;
    letter-spacing: 2px;
    color: var(--gray);
    text-transform: uppercase;
  }
  .count-badge {
    background: var(--red);
    color: white;
    font-size: 10px;
    padding: 2px 7px;
    border-radius: 10px;
    letter-spacing: 0;
  }

  /* Cards - Anuncios */
  .ad-card {
    border: 1px solid var(--border);
    background: white;
    margin-bottom: 16px;
    display: flex;
    gap: 0;
    position: relative;
    overflow: hidden;
    transition: box-shadow 0.2s;
  }
  .ad-card-accent {
    width: 4px;
    background: var(--border);
    flex-shrink: 0;
  }
  .ad-card.vendido .ad-card-accent { background: #27ae60; }
  .ad-card.reservado .ad-card-accent { background: #f39c12; }
  .ad-card.activo .ad-card-accent { background: var(--red); }

  .ad-image-slot {
    width: 90px;
    min-height: 90px;
    background: #f0ece6;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 28px;
    color: var(--border);
    overflow: hidden;
    position: relative;
  }
  .ad-image-slot img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    position: absolute;
    top: 0; left: 0;
  }

  .ad-content {
    padding: 12px 12px 12px 14px;
    flex: 1;
    min-width: 0;
  }
  .ad-title {
    font-family: 'Noto Serif JP', serif;
    font-size: 15px;
    font-weight: 400;
    margin-bottom: 4px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .ad-price {
    font-size: 18px;
    font-weight: 700;
    color: var(--red);
    letter-spacing: -0.5px;
  }
  .ad-price span { font-size: 11px; font-weight: 300; color: var(--gray); }
  .ad-desc {
    font-size: 11px;
    color: var(--gray);
    margin-top: 4px;
    line-height: 1.5;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  .ad-meta {
    display: flex;
    gap: 8px;
    margin-top: 8px;
    align-items: center;
    flex-wrap: wrap;
  }
  .status-chip {
    font-size: 9px;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    padding: 2px 8px;
    border: 1px solid;
  }
  .status-chip.activo { color: var(--red); border-color: var(--red); }
  .status-chip.vendido { color: #27ae60; border-color: #27ae60; }
  .status-chip.reservado { color: #f39c12; border-color: #f39c12; }
  .status-chip.borrador { color: var(--gray); border-color: var(--border); }
  .cat-chip {
    font-size: 9px;
    letter-spacing: 1px;
    text-transform: uppercase;
    color: var(--gray);
    background: var(--paper);
    padding: 2px 8px;
    border: 1px solid var(--border);
  }

  .ad-actions {
    display: flex;
    gap: 6px;
    padding: 8px 12px 12px 14px;
    align-items: flex-end;
    flex-direction: column;
    justify-content: space-between;
  }
  .icon-btn {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 16px;
    padding: 4px;
    color: var(--gray);
    transition: color 0.2s;
  }
  .icon-btn:active { color: var(--red); }

  /* Form */
  .form-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(26,26,26,0.85);
    z-index: 200;
    align-items: flex-end;
    justify-content: center;
  }
  .form-overlay.open { display: flex; }
  .form-panel {
    background: var(--paper);
    width: 100%;
    max-width: 640px;
    max-height: 92vh;
    overflow-y: auto;
    border-top: 3px solid var(--red);
    padding: 24px 20px calc(24px + env(safe-area-inset-bottom));
    animation: slideUp 0.3s ease;
  }
  @keyframes slideUp {
    from { transform: translateY(100%); }
    to { transform: translateY(0); }
  }
  .form-title {
    font-family: 'Noto Serif JP', serif;
    font-size: 18px;
    margin-bottom: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .form-grid { display: flex; flex-direction: column; gap: 14px; }
  .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
  label {
    display: flex;
    flex-direction: column;
    gap: 5px;
    font-size: 10px;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    color: var(--gray);
  }
  input, textarea, select {
    font-family: 'Noto Sans JP', sans-serif;
    font-size: 16px; /* Evita auto-zoom en iOS Safari */
    padding: 10px 12px;
    border: 1px solid var(--border);
    background: white;
    color: var(--ink);
    outline: none;
    transition: border-color 0.2s;
    width: 100%;
    font-weight: 300;
    border-radius: 0;
    -webkit-appearance: none;
  }
  select {
    background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 10px center;
    background-size: 12px;
  }
  input:focus, textarea:focus, select:focus { border-color: var(--ink); }
  textarea { resize: vertical; min-height: 80px; }
  .form-actions {
    display: flex;
    gap: 10px;
    margin-top: 20px;
    justify-content: flex-end;
  }

  /* Almac√©n */
  .caja-card {
    border: 1px solid var(--border);
    background: white;
    margin-bottom: 16px;
    overflow: hidden;
  }
  .caja-header {
    background: var(--ink);
    color: var(--paper);
    padding: 12px 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    cursor: pointer;
  }
  .caja-name {
    font-family: 'Noto Serif JP', serif;
    font-size: 15px;
    letter-spacing: 1px;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  
  /* Icono Bandera SVG para Cajas */
  .caja-icon { 
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .hanko-icon {
    width: 28px;
    height: 18px;
    border: 1px solid var(--paper);
    background: white;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .hanko-circle {
    width: 8px;
    height: 8px;
    background-color: var(--red);
    border-radius: 50%;
  }

  .caja-items-count {
    font-size: 11px;
    color: var(--gray);
    letter-spacing: 1px;
  }
  .caja-body {
    padding: 0;
    display: none;
  }
  .caja-body.open { display: block; }
  .caja-item {
    display: flex;
    align-items: center;
    padding: 10px 16px;
    border-bottom: 1px solid var(--border);
    gap: 12px;
    font-size: 13px;
  }
  .caja-item:last-child { border-bottom: none; }
  .caja-item-dot {
    width: 6px; height: 6px;
    border-radius: 50%;
    background: var(--border);
    flex-shrink: 0;
  }
  .caja-item-dot.linked { background: var(--red); }
  .caja-item-name { flex: 1; }
  .caja-item-linked {
    font-size: 10px;
    color: var(--red);
    letter-spacing: 1px;
    text-transform: uppercase;
  }
  .caja-add-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 16px;
    background: none;
    border: none;
    width: 100%;
    text-align: left;
    font-size: 11px;
    letter-spacing: 1px;
    color: var(--gray);
    cursor: pointer;
    border-top: 1px dashed var(--border);
    font-family: 'Noto Sans JP', sans-serif;
    text-transform: uppercase;
  }
  .caja-add-btn:active { color: var(--red); background: #fdfdfd; }

  /* Empty state */
  .empty {
    text-align: center;
    padding: 60px 20px;
    color: var(--gray);
  }
  .empty-jp {
    font-family: 'Noto Serif JP', serif;
    font-size: 36px;
    display: block;
    margin-bottom: 8px;
    opacity: 0.2;
  }
  .empty p { font-size: 12px; letter-spacing: 2px; text-transform: uppercase; }

  /* Stats bar */
  .stats-bar {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1px;
    background: var(--border);
    margin-bottom: 24px;
    border: 1px solid var(--border);
  }
  .stat-cell {
    background: white;
    padding: 14px 12px;
    text-align: center;
  }
  .stat-val {
    font-family: 'Noto Serif JP', serif;
    font-size: 22px;
    display: block;
    color: var(--red);
  }
  .stat-label { font-size: 9px; letter-spacing: 2px; text-transform: uppercase; color: var(--gray); }

  /* Wallapop copy area */
  .wallapop-box {
    background: #fff;
    border: 1px solid var(--border);
    border-top: none;
    padding: 16px;
    display: none;
  }
  .wallapop-box.open { display: block; }
  .wallapop-box h4 {
    font-size: 10px;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--gray);
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .wallapop-text {
    font-size: 13px;
    line-height: 1.7;
    white-space: pre-wrap;
    color: var(--ink);
    background: var(--paper);
    padding: 12px;
    border-left: 3px solid var(--red);
  }
  .copy-btn {
    margin-top: 8px;
    font-size: 10px;
    letter-spacing: 1px;
    text-transform: uppercase;
    background: var(--ink);
    color: white;
    border: none;
    padding: 8px 14px;
    cursor: pointer;
    transition: background 0.2s;
  }
  .copy-btn:active { background: var(--red); }

  /* Image upload area */
  .img-upload-area {
    border: 1px dashed var(--border);
    background: white;
    padding: 20px;
    text-align: center;
    cursor: pointer;
    transition: border-color 0.2s;
    position: relative;
  }
  .img-upload-area:active { border-color: var(--ink); background: var(--paper); }
  .img-upload-area input[type=file] {
    position: absolute;
    inset: 0;
    opacity: 0;
    cursor: pointer;
  }
  .img-upload-area p { font-size: 11px; color: var(--gray); letter-spacing: 1px; }
  
  /* Indicador de carga para la compresi√≥n */
  #loading-spinner {
    display: none;
    font-size: 11px;
    color: var(--red);
    margin-top: 8px;
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  .img-preview-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 6px;
    margin-top: 10px;
  }
  .img-preview {
    aspect-ratio: 1;
    background: #f0ece6;
    overflow: hidden;
    position: relative;
    border: 1px solid var(--border);
  }
  .img-preview img { width: 100%; height: 100%; object-fit: cover; }
  .img-preview .del-img {
    position: absolute;
    top: 2px; right: 2px;
    background: rgba(26,26,26,0.8);
    color: white;
    border: none;
    width: 20px; height: 20px;
    font-size: 10px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  /* Scrollbar */
  ::-webkit-scrollbar { width: 4px; }
  ::-webkit-scrollbar-track { background: var(--paper); }
  ::-webkit-scrollbar-thumb { background: var(--border); }

  /* FAB */
  .fab {
    position: fixed;
    bottom: calc(24px + env(safe-area-inset-bottom));
    right: 50%;
    transform: translateX(290px);
    background: var(--red);
    color: white;
    border: none;
    width: 56px; height: 56px;
    border-radius: 50%;
    font-size: 28px;
    font-weight: 300;
    cursor: pointer;
    box-shadow: 0 4px 16px rgba(192,57,43,0.4);
    transition: transform 0.2s, box-shadow 0.2s;
    z-index: 150;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .fab:active { transform: translateX(290px) scale(0.95); }
  @media (max-width: 640px) {
    .fab { right: 20px; transform: none; }
    .fab:active { transform: scale(0.95); }
  }

  /* Categor√≠as filter */
  .filter-row {
    display: flex;
    gap: 8px;
    margin-bottom: 20px;
    overflow-x: auto;
    padding-bottom: 4px;
    scrollbar-width: none;
  }
  .filter-row::-webkit-scrollbar { display: none; }
  .filter-chip {
    flex-shrink: 0;
    padding: 6px 16px;
    font-size: 10px;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    border: 1px solid var(--border);
    background: white;
    cursor: pointer;
    color: var(--gray);
    transition: all 0.15s;
    font-family: 'Noto Sans JP', sans-serif;
  }
  .filter-chip.active { background: var(--ink); color: white; border-color: var(--ink); }

</style>
</head>
<body>

<header>
  <div class="header-inner">
    <div class="logo">
      <span class="logo-jp">Â£≤„ÇäÂ†¥<span class="logo-dot"></span></span>
      <span class="logo-sub">Goodbye Things</span>
    </div>
    
    <!-- Botones de Exportar/Importar -->
    <div class="header-center">
      <button class="io-btn" onclick="exportData()">‚Üì exp</button>
      <button class="io-btn" onclick="document.getElementById('importFile').click()">‚Üë imp</button>
      <input type="file" id="importFile" accept=".json" style="display:none;" onchange="importData(event)">
    </div>

    <div style="font-size:11px;letter-spacing:2px;color:var(--gray);text-align:right;">
      <div style="color:var(--paper);font-family:'Noto Serif JP',serif;font-size:13px;">ÊâãÊîæ„Åô</div>
      <div>dejar ir</div>
    </div>
  </div>
</header>

<nav id="mainNav">
  <button class="active" onclick="showSection('anuncios')" id="nav-anuncios">
    <span class="nav-jp">Â∫ÉÂëä</span>
    anuncios
  </button>
  <button onclick="showSection('almacen')" id="nav-almacen">
    <span class="nav-jp">ÂÄâÂ∫´</span>
    almac√©n
  </button>
</nav>

<main>

  <!-- ANUNCIOS SECTION -->
  <section id="sec-anuncios">
    <div id="statsBar" class="stats-bar"></div>

    <div class="filter-row" id="filterRow"></div>

    <div class="section-head">
      <h2>Â∫ÉÂëä</h2>
      <span>anuncios</span>
      <span class="count-badge" id="adCount">0</span>
    </div>

    <div id="adList"></div>

    <div id="emptyAds" class="empty" style="display:none;">
      <span class="empty-jp">ÁÑ°</span>
      <p>Sin art√≠culos a√∫n</p>
    </div>
  </section>

  <!-- ALMAC√âN SECTION -->
  <section id="sec-almacen" style="display:none;">
    <div class="section-head">
      <h2>ÂÄâÂ∫´</h2>
      <span>almac√©n de cajas</span>
    </div>

    <div id="cajaList"></div>

    <div id="emptyCajas" class="empty" style="display:none;">
      <span class="empty-jp">ÁÆ±</span>
      <p>Sin cajas a√∫n</p>
    </div>

    <div style="margin-top:16px;">
      <button class="btn-primary" style="width: 100%;" onclick="openCajaForm()">+ Nueva Caja</button>
    </div>
  </section>

</main>

<!-- FAB -->
<button class="fab" id="fabBtn" onclick="openAdForm()" title="Nuevo anuncio">+</button>

<!-- FORM OVERLAY - ANUNCIO -->
<div class="form-overlay" id="adFormOverlay">
  <div class="form-panel">
    <div class="form-title">
      <span id="formTitle">Êñ∞„Åó„ÅÑÂ∫ÉÂëä ¬∑ Nuevo anuncio</span>
      <button class="icon-btn" onclick="closeAdForm()" style="font-size:20px;">‚úï</button>
    </div>

    <div class="form-grid">
      <label>
        T√≠tulo del art√≠culo
        <input type="text" id="f-title" placeholder="Ej: C√°mara anal√≥gica Nikon FM2">
      </label>

      <div class="form-row">
        <label>
          Precio (‚Ç¨)
          <input type="number" id="f-price" placeholder="0">
        </label>
        <label>
          Categor√≠a
          <select id="f-cat">
            <option value="Tecnolog√≠a">Tecnolog√≠a</option>
            <option value="Ropa">Ropa</option>
            <option value="Hogar">Hogar</option>
            <option value="Libros">Libros</option>
            <option value="Arte">Arte</option>
            <option value="Deporte">Deporte</option>
            <option value="M√∫sica">M√∫sica</option>
            <option value="Otro">Otro</option>
          </select>
        </label>
      </div>

      <label>
        Estado del art√≠culo
        <select id="f-condition">
          <option value="Como nuevo">Como nuevo</option>
          <option value="Muy buen estado">Muy buen estado</option>
          <option value="Buen estado">Buen estado</option>
          <option value="Aceptable">Aceptable</option>
        </select>
      </label>

      <label>
        Descripci√≥n para Wallapop
        <textarea id="f-desc" placeholder="Describe el art√≠culo con honestidad. Medidas, defectos, motivo de venta..."></textarea>
      </label>

      <div class="form-row">
        <label>
          Estado de venta
          <select id="f-status">
            <option value="borrador">Borrador</option>
            <option value="activo">Activo</option>
            <option value="reservado">Reservado</option>
            <option value="vendido">Vendido</option>
          </select>
        </label>
        <label>
          Caja asignada
          <select id="f-caja">
            <option value="">‚Äî Sin caja ‚Äî</option>
          </select>
        </label>
      </div>

      <label>
        Fotos
        <div class="img-upload-area">
          <input type="file" accept="image/*" multiple id="f-photos" onchange="handlePhotos(event)">
          <p>üì∑ Toca para a√±adir fotos</p>
          <div id="loading-spinner">Procesando imagen...</div>
        </div>
        <div class="img-preview-grid" id="photoPreviewGrid"></div>
      </label>
    </div>

    <div class="form-actions">
      <button class="btn-ghost" onclick="closeAdForm()">Cancelar</button>
      <button class="btn-primary" onclick="saveAd()">Guardar ‰øùÂ≠ò</button>
    </div>
  </div>
</div>

<!-- FORM OVERLAY - CAJA -->
<div class="form-overlay" id="cajaFormOverlay">
  <div class="form-panel">
    <div class="form-title">
      <span>ÁÆ± ¬∑ Nueva Caja</span>
      <button class="icon-btn" onclick="closeCajaForm()" style="font-size:20px;">‚úï</button>
    </div>
    <div class="form-grid">
      <label>
        Identificador de la caja
        <input type="text" id="cf-name" placeholder="Ej: CAJA-01">
      </label>
      <label>
        Descripci√≥n (opcional)
        <input type="text" id="cf-desc" placeholder="Ej: Junto a la ventana">
      </label>
    </div>
    <div class="form-actions">
      <button class="btn-ghost" onclick="closeCajaForm()">Cancelar</button>
      <button class="btn-primary" onclick="saveCaja()">Crear Caja</button>
    </div>
  </div>
</div>

<!-- FORM OVERLAY - ITEM EN CAJA -->
<div class="form-overlay" id="itemFormOverlay">
  <div class="form-panel">
    <div class="form-title">
      <span>Áâ©ÂìÅ ¬∑ A√±adir art√≠culo</span>
      <button class="icon-btn" onclick="closeItemForm()" style="font-size:20px;">‚úï</button>
    </div>
    <div class="form-grid">
      <label>
        Nombre del art√≠culo
        <input type="text" id="if-name" placeholder="¬øQu√© hay en esta caja?">
      </label>
      <label>
        Vincular con anuncio (opcional)
        <select id="if-ad">
          <option value="">‚Äî Sin vincular ‚Äî</option>
        </select>
      </label>
    </div>
    <div class="form-actions">
      <button class="btn-ghost" onclick="closeItemForm()">Cancelar</button>
      <button class="btn-primary" onclick="saveItem()">A√±adir</button>
    </div>
  </div>
</div>

<script>
// ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let ads = JSON.parse(localStorage.getItem('uriba_ads') || '[]');
let cajas = JSON.parse(localStorage.getItem('uriba_cajas') || '[]');
let editingAdId = null;
let editingCajaId = null;
let currentPhotos = []; // base64 array
let currentFilter = 'Todos';

// ‚îÄ‚îÄ Persistence ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function save() {
  localStorage.setItem('uriba_ads', JSON.stringify(ads));
  localStorage.setItem('uriba_cajas', JSON.stringify(cajas));
}

// ‚îÄ‚îÄ Import/Export Logic ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function exportData() {
  const data = { ads, cajas };
  const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data, null, 2));
  const downloadAnchorNode = document.createElement('a');
  downloadAnchorNode.setAttribute("href", dataStr);
  downloadAnchorNode.setAttribute("download", `uriba_backup_${new Date().toISOString().slice(0,10)}.json`);
  document.body.appendChild(downloadAnchorNode);
  downloadAnchorNode.click();
  downloadAnchorNode.remove();
}

function importData(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = JSON.parse(e.target.result);
      if (data.ads && data.cajas) {
        ads = data.ads;
        cajas = data.cajas;
        save();
        renderAds();
        if (document.getElementById('sec-almacen').style.display === 'block') {
          renderAlmacen();
        }
        alert('Datos importados correctamente / „Éá„Éº„Çø„Åå„Ç§„É≥„Éù„Éº„Éà„Åï„Çå„Åæ„Åó„Åü');
      } else {
        alert('El archivo no parece ser un backup v√°lido de Uriba.');
      }
    } catch (err) {
      alert('Error al leer el archivo JSON.');
    }
  };
  reader.readAsText(file);
  event.target.value = ''; // Reset file input
}

// ‚îÄ‚îÄ Nav ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showSection(id) {
  ['anuncios','almacen'].forEach(s => {
    document.getElementById('sec-'+s).style.display = s===id ? 'block' : 'none';
    document.getElementById('nav-'+s).classList.toggle('active', s===id);
  });
  const fab = document.getElementById('fabBtn');
  fab.style.display = id === 'anuncios' ? 'flex' : 'none';
  if (id === 'almacen') renderAlmacen();
  else renderAds();
}

// ‚îÄ‚îÄ Stats ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderStats() {
  const total = ads.length;
  const vendidos = ads.filter(a=>a.status==='vendido').length;
  const ganancias = ads.filter(a=>a.status==='vendido').reduce((s,a)=>s+(parseFloat(a.price)||0),0);
  document.getElementById('statsBar').innerHTML = `
    <div class="stat-cell"><span class="stat-val">${total}</span><span class="stat-label">art√≠culos</span></div>
    <div class="stat-cell"><span class="stat-val">${vendidos}</span><span class="stat-label">vendidos</span></div>
    <div class="stat-cell"><span class="stat-val">${ganancias.toFixed(0)}‚Ç¨</span><span class="stat-label">ganados</span></div>
  `;
}

// ‚îÄ‚îÄ Filters ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderFilters() {
  const cats = ['Todos', ...new Set(ads.map(a=>a.category))];
  document.getElementById('filterRow').innerHTML = cats.map(c =>
    `<button class="filter-chip ${c===currentFilter?'active':''}" onclick="setFilter('${c}')">${c}</button>`
  ).join('');
}
function setFilter(cat) {
  currentFilter = cat;
  renderAds();
}

// ‚îÄ‚îÄ Ads Render ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderAds() {
  renderStats();
  renderFilters();
  const filtered = currentFilter==='Todos' ? ads : ads.filter(a=>a.category===currentFilter);
  document.getElementById('adCount').textContent = filtered.length;
  const el = document.getElementById('adList');
  document.getElementById('emptyAds').style.display = filtered.length ? 'none' : 'block';

  el.innerHTML = filtered.map(ad => {
    const img = ad.photos && ad.photos[0]
      ? `<img src="${ad.photos[0]}" alt="">`
      : 'üì∏';
    const cajaName = ad.cajaId ? (cajas.find(c=>c.id===ad.cajaId)||{name:'?'}).name : '';
    return `
    <div class="ad-card ${ad.status}">
      <div class="ad-card-accent"></div>
      <div class="ad-image-slot">${img}</div>
      <div class="ad-content">
        <div class="ad-title">${ad.title || 'Sin t√≠tulo'}</div>
        <div class="ad-price">${ad.price ? ad.price+'‚Ç¨' : '‚Äî'} <span>¬∑ ${ad.condition||''}</span></div>
        <div class="ad-desc">${ad.desc||''}</div>
        <div class="ad-meta">
          <span class="status-chip ${ad.status}">${ad.status}</span>
          <span class="cat-chip">${ad.category||''}</span>
          ${cajaName ? `<span class="cat-chip">üì¶ ${cajaName}</span>` : ''}
        </div>
      </div>
      <div class="ad-actions">
        <button class="icon-btn" onclick="editAd('${ad.id}')" title="Editar">‚úé</button>
        <button class="icon-btn" onclick="toggleWallapop('${ad.id}')" title="Wallapop">üìã</button>
        <button class="icon-btn" onclick="deleteAd('${ad.id}')" title="Eliminar" style="color:var(--red)">‚úï</button>
      </div>
    </div>
    <div class="wallapop-box" id="wbox-${ad.id}">
      <h4>üìã Texto para Wallapop</h4>
      <div class="wallapop-text">${generateWallapopText(ad)}</div>
      <button class="copy-btn" onclick="copyWallapop('${ad.id}')">Copiar texto</button>
    </div>
    `;
  }).join('');
}

function generateWallapopText(ad) {
  return [
    ad.title,
    '',
    ad.desc,
    '',
    `Estado: ${ad.condition || 'Buen estado'}`,
    `Categor√≠a: ${ad.category || ''}`,
    '',
    'üìç Entrega en mano o env√≠o acordado.',
    'Precio: ' + (ad.price ? ad.price + '‚Ç¨' : 'a convenir'),
  ].filter(l=>l!==undefined).join('\n');
}

function toggleWallapop(id) {
  const box = document.getElementById('wbox-'+id);
  box.classList.toggle('open');
}

function copyWallapop(id) {
  const ad = ads.find(a=>a.id===id);
  if (!ad) return;
  navigator.clipboard.writeText(generateWallapopText(ad));
  const btn = event.target;
  btn.textContent = '‚úì Copiado';
  setTimeout(()=>btn.textContent='Copiar texto', 2000);
}

function deleteAd(id) {
  if (!confirm('¬øEliminar este anuncio permanentemente?')) return;
  ads = ads.filter(a=>a.id!==id);
  // Remove from cajas
  cajas.forEach(c=>{ c.items = c.items.filter(i=>i.adId!==id); });
  save();
  renderAds();
}

function editAd(id) {
  const ad = ads.find(a=>a.id===id);
  if (!ad) return;
  editingAdId = id;
  currentPhotos = ad.photos ? [...ad.photos] : [];
  document.getElementById('f-title').value = ad.title || '';
  document.getElementById('f-price').value = ad.price || '';
  document.getElementById('f-cat').value = ad.category || 'Otro';
  document.getElementById('f-condition').value = ad.condition || 'Buen estado';
  document.getElementById('f-desc').value = ad.desc || '';
  document.getElementById('f-status').value = ad.status || 'borrador';
  populateCajaSelect(ad.cajaId);
  renderPhotoPreview();
  document.getElementById('formTitle').textContent = 'Á∑®ÈõÜ ¬∑ Editar anuncio';
  document.getElementById('adFormOverlay').classList.add('open');
}

// ‚îÄ‚îÄ Ad Form & Image Compression ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openAdForm() {
  editingAdId = null;
  currentPhotos = [];
  document.getElementById('f-title').value = '';
  document.getElementById('f-price').value = '';
  document.getElementById('f-cat').value = 'Otro';
  document.getElementById('f-condition').value = 'Buen estado';
  document.getElementById('f-desc').value = '';
  document.getElementById('f-status').value = 'borrador';
  document.getElementById('photoPreviewGrid').innerHTML = '';
  populateCajaSelect('');
  document.getElementById('formTitle').textContent = 'Êñ∞„Åó„ÅÑÂ∫ÉÂëä ¬∑ Nuevo anuncio';
  document.getElementById('adFormOverlay').classList.add('open');
}

function closeAdForm() {
  document.getElementById('adFormOverlay').classList.remove('open');
}

function populateCajaSelect(selected) {
  const sel = document.getElementById('f-caja');
  sel.innerHTML = '<option value="">‚Äî Sin caja ‚Äî</option>' +
    cajas.map(c=>`<option value="${c.id}" ${c.id===selected?'selected':''}>${c.name}</option>`).join('');
}

// Nuevo sistema de compresi√≥n para evitar llenar la memoria del iPhone
function handlePhotos(e) {
  const files = Array.from(e.target.files);
  if (!files.length) return;
  
  const spinner = document.getElementById('loading-spinner');
  spinner.style.display = 'block';
  
  let processed = 0;

  files.forEach(f => {
    const reader = new FileReader();
    reader.onload = ev => {
      const img = new Image();
      img.onload = () => {
        const canvas = document.createElement('canvas');
        const MAX_WIDTH = 800; // Resoluci√≥n ideal para web
        const MAX_HEIGHT = 800;
        let width = img.width;
        let height = img.height;

        if (width > height) {
          if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
        } else {
          if (height > MAX_HEIGHT) { width *= MAX_HEIGHT / height; height = MAX_HEIGHT; }
        }
        
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, width, height);
        
        // Comprime a formato JPEG con un 70% de calidad
        const compressedDataUrl = canvas.toDataURL('image/jpeg', 0.7);
        currentPhotos.push(compressedDataUrl);
        
        processed++;
        if (processed === files.length) {
            spinner.style.display = 'none';
            renderPhotoPreview();
        }
      };
      img.src = ev.target.result;
    };
    reader.readAsDataURL(f);
  });
}

function renderPhotoPreview() {
  document.getElementById('photoPreviewGrid').innerHTML = currentPhotos.map((p,i)=>`
    <div class="img-preview">
      <img src="${p}">
      <button class="del-img" onclick="removePhoto(${i})">‚úï</button>
    </div>
  `).join('');
}

function removePhoto(i) {
  currentPhotos.splice(i, 1);
  renderPhotoPreview();
}

function saveAd() {
  const title = document.getElementById('f-title').value.trim();
  if (!title) { alert('El t√≠tulo es obligatorio'); return; }
  const newCajaId = document.getElementById('f-caja').value;
  const adId = editingAdId || Date.now().toString();
  const oldAd = editingAdId ? ads.find(a=>a.id===editingAdId) : null;
  const oldCajaId = oldAd ? oldAd.cajaId : '';

  const ad = {
    id: adId,
    title,
    price: document.getElementById('f-price').value,
    category: document.getElementById('f-cat').value,
    condition: document.getElementById('f-condition').value,
    desc: document.getElementById('f-desc').value,
    status: document.getElementById('f-status').value,
    cajaId: newCajaId,
    photos: currentPhotos,
    createdAt: oldAd ? oldAd.createdAt : Date.now(),
  };

  if (editingAdId) {
    const i = ads.findIndex(a=>a.id===editingAdId);
    ads[i] = ad;
  } else {
    ads.unshift(ad);
  }

  // Sync cajas: remove from old caja if changed
  if (oldCajaId && oldCajaId !== newCajaId) {
    const oldCaja = cajas.find(c=>c.id===oldCajaId);
    if (oldCaja) oldCaja.items = oldCaja.items.filter(i=>i.adId!==adId);
  }

  // Add to new caja if assigned and not already there
  if (newCajaId) {
    const newCaja = cajas.find(c=>c.id===newCajaId);
    if (newCaja) {
      const alreadyIn = newCaja.items.some(i=>i.adId===adId);
      if (!alreadyIn) {
        newCaja.items.push({ name: title, adId });
      } else {
        // Update name in case title changed
        const item = newCaja.items.find(i=>i.adId===adId);
        if (item) item.name = title;
      }
    }
  }

  save();
  closeAdForm();
  renderAds();
}

// ‚îÄ‚îÄ Almac√©n ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderAlmacen() {
  const el = document.getElementById('cajaList');
  document.getElementById('emptyCajas').style.display = cajas.length ? 'none' : 'block';
  el.innerHTML = cajas.map(c => `
    <div class="caja-card">
      <div class="caja-header" onclick="toggleCaja('${c.id}')">
        <div class="caja-name">
          <span class="caja-icon">
            <div class="hanko-icon"><div class="hanko-circle"></div></div>
          </span>
          ${c.name}
          ${c.desc ? `<span style="font-family:'Noto Sans JP';font-weight:300;font-size:12px;color:var(--gray);">${c.desc}</span>` : ''}
        </div>
        <span class="caja-items-count">${(c.items||[]).length} obj.</span>
      </div>
      <div class="caja-body" id="caja-body-${c.id}">
        ${(c.items||[]).length === 0 ? '<div class="caja-item" style="color:var(--gray);font-size:12px;">‚Äî vac√≠a ‚Äî</div>' :
          (c.items||[]).map((item,i) => {
            const linked = item.adId ? ads.find(a=>a.id===item.adId) : null;
            return `
            <div class="caja-item">
              <div class="caja-item-dot ${linked?'linked':''}"></div>
              <div class="caja-item-name">${item.name}</div>
              ${linked ? `<span class="caja-item-linked">‚Üí ${linked.title}</span>` : ''}
              <button class="icon-btn" onclick="removeItem('${c.id}',${i})" style="font-size:12px;">‚úï</button>
            </div>
          `}).join('')
        }
        <button class="caja-add-btn" onclick="openItemForm('${c.id}')">+ a√±adir objeto a la caja</button>
      </div>
    </div>
  `).join('');
}

function toggleCaja(id) {
  const body = document.getElementById('caja-body-'+id);
  body.classList.toggle('open');
}

function openCajaForm() {
  document.getElementById('cf-name').value = '';
  document.getElementById('cf-desc').value = '';
  document.getElementById('cajaFormOverlay').classList.add('open');
}
function closeCajaForm() {
  document.getElementById('cajaFormOverlay').classList.remove('open');
}
function saveCaja() {
  const name = document.getElementById('cf-name').value.trim();
  if (!name) { alert('Nombre obligatorio'); return; }
  cajas.push({ id: Date.now().toString(), name, desc: document.getElementById('cf-desc').value, items: [] });
  save();
  closeCajaForm();
  renderAlmacen();
}

let currentCajaId = null;
function openItemForm(cajaId) {
  currentCajaId = cajaId;
  document.getElementById('if-name').value = '';
  const sel = document.getElementById('if-ad');
  sel.innerHTML = '<option value="">‚Äî Sin vincular ‚Äî</option>' +
    ads.map(a=>`<option value="${a.id}">${a.title}</option>`).join('');
  document.getElementById('itemFormOverlay').classList.add('open');
}
function closeItemForm() {
  document.getElementById('itemFormOverlay').classList.remove('open');
}
function saveItem() {
  const name = document.getElementById('if-name').value.trim();
  if (!name) { alert('Nombre obligatorio'); return; }
  const caja = cajas.find(c=>c.id===currentCajaId);
  if (!caja) return;
  const adId = document.getElementById('if-ad').value;
  caja.items.push({ name, adId });
  // Auto-assign caja to ad
  if (adId) {
    const ad = ads.find(a=>a.id===adId);
    if (ad) ad.cajaId = currentCajaId;
  }
  save();
  closeItemForm();
  renderAlmacen();
}
function removeItem(cajaId, i) {
  if (!confirm('¬øQuitar objeto de la caja?')) return;
  const caja = cajas.find(c=>c.id===cajaId);
  if (!caja) return;
  caja.items.splice(i, 1);
  save();
  renderAlmacen();
}

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
renderAds();
</script>
</body>
</html>
